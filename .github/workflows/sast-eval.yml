name: SAST Tool Evaluation Workflow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  sast-scan:
    name: Run SAST Checks
    runs-on: ubuntu-latest
    services:
      sonarqube:
        image: sonarqube:9.9-community # Use LTS to ensure compatibility with scanner and avoid API breakages
        ports:
          - 9000:9000
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Semgrep Scan
      - name: Semgrep Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: security/sast/semgrep/semgrep-config.yaml
        continue-on-error: true

      # SonarQube Scan (Self-hosted in CI)
      - name: Wait for SonarQube to be ready
        run: |
          echo "Waiting for SonarQube..."
          count=0
          while ! curl -s http://localhost:9000 > /dev/null; do
            echo "Waiting..."
            sleep 5
            count=$((count+1))
            if [ $count -gt 60 ]; then
              echo "SonarQube failed to start"
              exit 1
            fi
          done
          echo "SonarQube is up!"
          echo "Changing default password..."
          curl -u admin:admin -X POST "http://localhost:9000/api/users/change_password?login=admin&previousPassword=admin&password=newstrongpassword123"
          echo "Password changed."

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} # Ideally used, but for internal ephemeral, we might rely on default admin
          SONAR_HOST_URL: http://localhost:9000
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=sast-evaluation-project
            -Dsonar.login=admin
            -Dsonar.password=newstrongpassword123


      # Trivy Scan (Filesystem)
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: security/supply-chain/trivy/trivy-config.yaml
        continue-on-error: true
