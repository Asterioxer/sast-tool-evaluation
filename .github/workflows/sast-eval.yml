name: SAST Tool Evaluation Workflow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  sast-scan:
    name: Run SAST Checks
    runs-on: ubuntu-latest
    services:
      sonarqube:
        image: sonarqube:9.9-community # Use LTS to ensure compatibility with scanner and avoid API breakages
        ports:
          - 9000:9000
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Semgrep Scan
      - name: Semgrep Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: security/sast/semgrep/semgrep-config.yaml
        continue-on-error: true

      # SonarQube Scan (Self-hosted in CI)
      - name: Wait for SonarQube to be ready
        run: |
          echo "Waiting for SonarQube..."
          count=0
          while ! curl -s "http://localhost:9000/api/system/status" | grep -q '"status":"UP"'; do
            echo "Waiting for SonarQube to be UP..."
            sleep 5
            count=$((count+1))
            if [ $count -gt 60 ]; then
              echo "SonarQube failed to start or is not ready"
              curl -v http://localhost:9000/api/system/status || true
              exit 1
            fi
          done
          echo "SonarQube is UP!"
          echo "Changing default password..."
          # Use form data for POST to avoid URL encoding issues and ensure correct API usage for 9.9 LTS
          curl -v -u admin:admin -X POST "http://localhost:9000/api/users/change_password" \
            -d "login=admin" \
            -d "previousPassword=admin" \
            -d "password=newstrongpassword123"
          echo "Password changed."

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          # SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} # Removed to avoid conflict with login/password auth
          SONAR_HOST_URL: http://localhost:9000
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=sast-evaluation-project
            -Dsonar.login=admin
            -Dsonar.password=newstrongpassword123


      # Trivy Scan (Filesystem)
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: security/supply-chain/trivy/trivy-config.yaml
        continue-on-error: true
